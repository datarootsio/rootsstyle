name: Push Workflow
on:
  push:
    branches:
      - '**'

jobs:
  linting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ./.github/workflows/composite/linting
  
  # testing-and-codecov:
  #   needs: linting
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       python-version: ["3.7.1", "3.8", "3.9", "3.10"]

  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: ./.github/workflows/composite/testing
  #       with:
  #         python_version: ${{ matrix.python-version }}

  #     # upload to codecov
  #     - name: upload coverage to Codecov
  #       if: ${{ matrix.python-version == '3.8' }}
  #       uses: codecov/codecov-action@v2
  #       with:
  #         token: ${{ secrets.CODECOV_TOKEN }}
  #         file: coverage.xml
  #         fail_ci_if_error: true
  
  # Tag, release and publish
  tag-release-and-publish:
    #needs: testing-and-codecov
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      # Create new version
      # NOTE: commit messages are parsed semantically: https://github.com/mathieudutour/github-tag-action#bumping
      - name: Create tag
        id: create_tag
        uses: mathieudutour/github-tag-action@v6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: false #no tags unless major, minor or patch tag
          default_prerelease_bump: false #no tags unless major, minor or patch tag
          append_to_pre_release_tag: "test"
      - run: |
          echo ${{ steps.create_tag.outputs.new_tag }}
          echo ${{ steps.create_tag.outputs.new_version }}

      # Create release with tag
      - name: Create a GitHub release
        if: ${{ steps.create_tag.outputs.release_type == 'major' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.create_tag.outputs.new_tag }}
          name: Release ${{ steps.create_tag.outputs.new_tag }}
          body: Automated Changelog will come here
      # Publish      
      - uses: ./.github/workflows/composite/publishing
        if: ${{ steps.create_tag.outputs.release_type == 'major' }}
        with:
          package_version: ${{ steps.create_tag.outputs.new_tag }}
          pypi_username: ${{ secrets.PyPI_USERNAME }}
          pypi_password: ${{ secrets.PyPI_PASSWORD }}